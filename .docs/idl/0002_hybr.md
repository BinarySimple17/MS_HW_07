# API IDL: Решение 0002 - Гибридная архитектура (HTTP + Kafka)

## Общее описание
Гибридная архитектура с комбинацией синхронных HTTP-вызовов для критических операций и асинхронного взаимодействия через Kafka для нотификаций.

## HTTP API

### Order Service API:
```yaml
openapi: 3.1.0
paths:
  /api/v1/order:
    post:
      summary: Создание нового заказа
      parameters:
        - name: X-Username
          in: header
          required: true
        - name: Authorization
          in: header
          required: true
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                orderPositions:
                  type: array
                  items:
                    $ref: '#/components/schemas/OrderPositionDto'
                shopId:
                  type: integer
                status:
                  type: string
                  enum: ['New', 'Delivery failed', 'Insufficient funds', 'Failed', 'In progress', 'Done', 'Canceled']
                totalCost:
                  type: number
                username:
                  type: string
      responses:
        200:
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OrderResultDto'
        400:
          description: Invalid request data
        401:
          description: Unauthorized
        422:
          description: Validation error
  /api/v1/order/{id}:
    get:
      summary: Получение информации о заказе
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        200:
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OrderResultDto'
        404:
          description: Order not found
```

### Billing Service API:
```yaml
openapi: 3.1.0
paths:
  /billing/account/operate:
    post:
      summary: Выполнение операции со счетом
      parameters:
        - name: X-Username
          in: header
          required: true
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                type:
                  type: string
                  enum: ['Withdrawal', 'Payment', 'Deposit']
                amount:
                  type: number
                account:
                  $ref: '#/components/schemas/AccountOperationDto'
      responses:
        200:
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OperationDto'
  /billing/account/new:
    post:
      summary: Создание нового счета
      parameters:
        - name: X-Username
          in: header
          required: true
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                username:
                  type: string
                balance:
                  type: number
      responses:
        200:
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AccountFullDto'
  /billing/account/full:
    get:
      summary: Получение полной информации о счете
      parameters:
        - name: X-Username
          in: header
          required: true
      responses:
        200:
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AccountFullDto'
  /billing/account/balance:
    get:
      summary: Получение баланса счета
      parameters:
        - name: X-Username
          in: header
          required: true
      responses:
        200:
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AccountInfoDto'
```

### User Service API:
```yaml
openapi: 3.1.0
paths:
  /api/v1/user/{username}:
    get:
      summary: Получение профиля пользователя
      parameters:
        - name: username
          in: path
          required: true
          schema:
            type: string
      responses:
        200:
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  username:
                    type: string
                  email:
                    type: string
                  phone:
                    type: string
        404:
          description: User not found
```

### Notification Service API:
```yaml
openapi: 3.1.0
paths:
  /api/v1/notification:
    post:
      summary: Создание уведомления
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                notificationType:
                  type: string
                  enum: ['Info', 'Warning', 'Error', 'Success', 'Fail', 'Default']
                parentType:
                  type: string
                  enum: ['Order', 'Payment', 'User']
                username:
                  type: string
                text:
                  type: string
                contact:
                  $ref: '#/components/schemas/NotificationContact'
                parentId:
                  type: integer
      responses:
        200:
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/NotificationDto'
  /notif:
    get:
      summary: Получение списка уведомлений
      parameters:
        - name: username
          in: query
          schema:
            type: string
        - name: notificationType
          in: query
          schema:
            type: string
            enum: ['Info', 'Warning', 'Error', 'Success', 'Fail', 'Default']
        - name: parentType
          in: query
          schema:
            type: string
            enum: ['Order', 'Payment', 'User']
        - name: parentId
          in: query
          schema:
            type: integer
        - name: page
          in: query
          schema:
            type: integer
            default: 0
        - name: size
          in: query
          schema:
            type: integer
            default: 20
      responses:
        200:
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PagedModelNotificationDto'
```

## Kafka Events

### Топик: orders.created
Событие о создании заказа
- **Producer**: order_service
- **Consumer**: notif_service
- **Message structure**:
```json
{
  "username": "string",
  "orderId": "long",
  "totalCost": "double",
  "status": "string",
  "createdAt": "long"
}
```

### Топик: users.registered
Событие о регистрации пользователя
- **Producer**: auth_service
- **Consumer**: user_service, billng_service
- **Message structure**:
```json
{
  "username": "string",
  "email": "string",
  "registeredAt": "long",
  "source": "string"
}
```